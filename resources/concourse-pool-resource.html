<!DOCTYPE html>
<html lang="en">
<head>
    
    <title>Duty Free - pool resource</title>

    <link rel="stylesheet" type="text/css" href="/dutyfree/static/style.css">
</head>
<body>
<div class="container">
    <div class="logo-area">
        <div class="title">
            <h1>CONCOURSE DUTY FREE</h1>
        </div>
    </div>


    <div class="search">
         
    </div>

    <nav class="sidebar">
         
    </nav>

    <main class="content">

        <div class="breadcrumb">
        
        
            
                    <span class="breadcrumb-link"><a href="/dutyfree">All Resources</a></span>
                
        
            
                    <span>pool resource</span>
            
        
        </div>

        
    <section class="top-area">
        <h2>pool resource</h2>
        <div>
            <a target="_blank" href="https://github.com/concourse/pool-resource">
                <img src="/dutyfree/static/GitHub-Mark-120px-plus.png" alt="Resource Source on Github"
                     class="github-icon-detail"
                     title="Resource Source on Github">
            </a>
            <a href="https://github.com/concourse" target="_blank" class="author">concourse</a>
        </div>
    </section>
    <section class="middle-area">
        <div class="description">
            <h3>Description</h3>
            <p class="desc">A pool of locks (modeling semaphores). Allows you to lock environments, pipeline flow, or other entities which have to be interacted with in a serial manner.</p>
        </div>
    </section>
    <section id="github-readme">
        <h3>Read Me</h3>
        <div id="readme" class="instapaper_body md" data-path="README.md"><article class="markdown-body entry-content p-5" itemprop="text"><h1><a id="user-content-pool-resource" class="anchor" aria-hidden="true" href="#pool-resource"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>pool-resource</h1>
<p><em>a pool of locks (modeling semaphores)</em></p>
<p>Allows you to lock environments, pipeline flow, or other entities which have to
be interacted with in a serial manner.</p>
<p>This resource is backed by a Git repository, so the configuration is largely the
same as the git-resource.</p>
<h2><a id="user-content-git-repository-structure" class="anchor" aria-hidden="true" href="#git-repository-structure"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Git Repository Structure</h2>
<pre><code>.
├── aws
│   ├── claimed
│   │   ├── .gitkeep
│   │   └── env-2
│   └── unclaimed
│       ├── .gitkeep
│       └── env-1
├── ping-pong-tables
│   ├── claimed
│   │   └── .gitkeep
│   └── unclaimed
│       ├── .gitkeep
│       └── north-table
└── vsphere
    ├── claimed
    │   ├── .gitkeep
    │   └── f3cb3823-a45a-49e8-ab41-e43268494205
    └── unclaimed
        ├── .gitkeep
        └── 83ed9977-3a10-4c49-a818-2d7a37693da7
</code></pre>
<p>This structure represents 3 pools of locks, <code>aws</code>, <code>ping-pong-tables</code>, and
<code>vsphere</code>. The <code>.gitkeep</code> files are required to keep the <code>unclaimed</code> and
<code>claimed</code> directories track-able by Git if there are no files in them.</p>
<p>You will need to mirror this structure in your own lock repository. In other words, initialize an empty repository
and create one directory in the root of the repository for each pool of locks (e.g. <code>aws</code>).  Inside of each lock pool directory, create one directory
named <code>claimed</code> and one directory named <code>unclaimed</code>. Inside each <code>claimed</code> and <code>unclaimed</code> directory, create an empty
filed named <code>.gitkeep</code>. Finally, create individual locks by making an empty file inside of the <code>unclaimed</code> directory
(assuming you want your lock to be unclaimed by default) with the desired name of the lock (e.g. <code>env-1</code>).</p>
<h2><a id="user-content-source-configuration" class="anchor" aria-hidden="true" href="#source-configuration"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Source Configuration</h2>
<ul>
<li>
<p><code>uri</code>: <em>Required.</em> The location of the repository.</p>
</li>
<li>
<p><code>branch</code>: <em>Required.</em> The branch to track.</p>
</li>
<li>
<p><code>pool</code>: <em>Required.</em> The logical name of your pool of things to lock.</p>
</li>
<li>
<p><code>private_key</code>: <em>Optional.</em> Private key to use when pulling/pushing. Ensure it does not require a password.
Example:</p>
<pre><code>private_key: |
  -----BEGIN RSA PRIVATE KEY-----
  MIIEowIBAAKCAQEAtCS10/f7W7lkQaSgD/mVeaSOvSF9ql4hf/zfMwfVGgHWjj+W
  &lt;Lots more text&gt;
  DWiJL+OFeg9kawcUL6hQ8JeXPhlImG6RTUffma9+iGQyyBMCGd1l
  -----END RSA PRIVATE KEY-----
</code></pre>
</li>
<li>
<p><code>username</code>: <em>Optional.</em> Username for HTTP(S) auth when pulling/pushing.
This is needed when only HTTP/HTTPS protocol for git is available (which does not support private key auth) and auth is required.</p>
</li>
<li>
<p><code>password</code>: <em>Optional.</em> Password for HTTP(S) auth when pulling/pushing.</p>
</li>
<li>
<p><code>retry_delay</code>: <em>Optional.</em> If specified, dictates how long to wait until
retrying to acquire a lock or release a lock. The default is 10 seconds.
Valid values: <code>60s</code>, <code>90m</code>, <code>1h</code>.</p>
</li>
</ul>
<h2><a id="user-content-behavior" class="anchor" aria-hidden="true" href="#behavior"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Behavior</h2>
<h3><a id="user-content-check-check-for-changes-to-the-pool" class="anchor" aria-hidden="true" href="#check-check-for-changes-to-the-pool"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>check</code>: Check for changes to the pool.</h3>
<p>The repository is cloned (or pulled if already present), and any commits made to the specified pool from the given version on are returned. If no version is
given, the ref for <code>HEAD</code> is returned.</p>
<h3><a id="user-content-in-fetch-an-acquired-lock" class="anchor" aria-hidden="true" href="#in-fetch-an-acquired-lock"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>in</code>: Fetch an acquired lock.</h3>
<p>Outputs 2 files:</p>
<ul>
<li>
<p><code>metadata</code>: Contains the contents of whatever was in your lock file. This is
useful for environment configuration settings.</p>
</li>
<li>
<p><code>name</code>: Contains the name of lock that was acquired.</p>
</li>
</ul>
<h3><a id="user-content-out-acquire-release-add-or-remove-a-lock" class="anchor" aria-hidden="true" href="#out-acquire-release-add-or-remove-a-lock"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><code>out</code>: Acquire, release, add, or remove a lock.</h3>
<p>Performs one of the following actions to change the state of the pool.</p>
<h4><a id="user-content-parameters" class="anchor" aria-hidden="true" href="#parameters"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Parameters</h4>
<p>One of the following is required.</p>
<ul>
<li>
<p><code>acquire</code>: If true, we will attempt to move a randomly chosen lock from the
pool's unclaimed directory to the claimed directory. Acquiring will retry
until a lock becomes available.</p>
</li>
<li>
<p><code>claim</code>: If set, the specified lock from the pool will be acquired, rather
than a random one (as in <code>acquire</code>). Like <code>acquire</code>, claiming will retry
until the specific lock becomes available.</p>
</li>
<li>
<p><code>release</code>: If set, we will release the lock by moving it from claimed to
unclaimed. The value is the path of the lock to release (a directory
containing <code>name</code> and <code>metadata</code>), which typically is just the step that
provided the lock (either a <code>get</code> to pass one along or a <code>put</code> to acquire).</p>
<p>Note: the lock must be available in your job before you can release it. In
other words, a <code>get</code> step to fetch metadata about the lock is necessary
before a <code>put</code> step can release the lock.</p>
</li>
<li>
<p><code>add</code>: If set, we will add a new lock to the pool in the unclaimed state. The
value is the path to a directory containing the files <code>name</code> and <code>metadata</code>
which should contain the name of your new lock and the contents you would like
in the lock, respectively.</p>
</li>
<li>
<p><code>add_claimed</code>: Exactly the same as the <code>add</code> param, but adds a lock to the
pool in the <em>claimed</em> state.</p>
</li>
<li>
<p><code>remove</code>: If set, we will remove the given lock from the pool. The value is
the same as <code>release</code>. This can be used for e.g. tearing down an environment,
or moving a lock between pools by using <code>add</code> with a different pool in a
second step.</p>
</li>
<li>
<p><code>update</code>: If set, we will update an existing lock in the pool.</p>
<ul>
<li>If the existing lock is in the unclaimed state we will update it with the
contents of the <code>metadata</code> file.</li>
<li>If no such lock is present in either the claimed or unclaimed state we add a
new lock to the pool in the unclaimed state.</li>
<li>If the lock is in the claimed state we will wait for it to be unclaimed and
proceed to update it as above.</li>
</ul>
<p>The value is the path to a directory containing the files <code>name</code> and
<code>metadata</code> which should contain the name of your new lock and the contents you
would like in the lock, respectively.</p>
</li>
</ul>
<h2><a id="user-content-example-concourse-configuration" class="anchor" aria-hidden="true" href="#example-concourse-configuration"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Example Concourse Configuration</h2>
<p>The following example pipeline models acquiring, passing through, and releasing
a lock based on the example git repository structure:</p>
<pre><code>resources:
- name: aws-environments
  type: pool
  source:
    uri: git@github.com:concourse/locks.git
    branch: master
    pool: aws
    private_key: |
      -----BEGIN RSA PRIVATE KEY-----
      MIIEowIBAAKCAQEAtCS10/f7W7lkQaSgD/mVeaSOvSF9ql4hf/zfMwfVGgHWjj+W
      &lt;Lots more text&gt;
      DWiJL+OFeg9kawcUL6hQ8JeXPhlImG6RTUffma9+iGQyyBMCGd1l
      -----END RSA PRIVATE KEY-----

jobs:
- name: deploy-aws
  plan:
    - put: aws-environments
      params: {acquire: true}
    - task: deploy-aws
      file: my-scripts/deploy-aws.yml

- name: test-aws
  plan:
    - get: aws-environments
      passed: [deploy-aws]
    - task: test-aws
      file: my-scripts/test-aws.yml
    - put: aws-environments
      params: {release: aws-environments}
</code></pre>
<h3><a id="user-content-managing-multiple-locks" class="anchor" aria-hidden="true" href="#managing-multiple-locks"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Managing multiple locks</h3>
<p>The parameter for <code>release</code> is the name of the step whose lock to release.
Normally this is just the same as the name of the resource, but if you have
custom names for <code>put</code> (for example if you need to acquire multiple instances
of the same pool), you would put that name instead. For example:</p>
<pre><code>- name: test-multi-aws
  plan:
    - put: environment-1
      resource: aws-environments
      params: {acquire: true}
    - put: environment-2
      resource: aws-environments
      params: {acquire: true}
    - task: test-multi-aws
      file: my-scripts/test-multi-aws.yml
    - put: aws-environments
      params: {release: environment-1}
    - put: aws-environments
      params: {release: environment-2}
</code></pre>
<h2><a id="user-content-development" class="anchor" aria-hidden="true" href="#development"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Development</h2>
<h3><a id="user-content-prerequisites" class="anchor" aria-hidden="true" href="#prerequisites"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Prerequisites</h3>
<ul>
<li>golang is <em>required</em> - version 1.9.x is tested; earlier versions may also
work.</li>
<li>docker is <em>required</em> - version 17.06.x is tested; earlier versions may also
work.</li>
<li>godep is used for dependency management of the golang packages.</li>
</ul>
<h3><a id="user-content-running-the-tests" class="anchor" aria-hidden="true" href="#running-the-tests"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Running the tests</h3>
<p>The tests have been embedded with the <code>Dockerfile</code>; ensuring that the testing
environment is consistent across any <code>docker</code> enabled platform. When the docker
image builds, the test are run inside the docker container, on failure they
will stop the build.</p>
<p>Run the tests with the following commands for both <code>alpine</code> and <code>ubuntu</code> images:</p>
<div class="highlight highlight-source-shell"><pre>docker build -t pool-resource -f dockerfiles/alpine/Dockerfile <span class="pl-c1">.</span>
docker build -t pool-resource -f dockerfiles/ubuntu/Dockerfile <span class="pl-c1">.</span></pre></div>
<h3><a id="user-content-contributing" class="anchor" aria-hidden="true" href="#contributing"><svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Contributing</h3>
<p>Please make all pull requests to the <code>master</code> branch and ensure tests pass
locally.</p>
</article></div>
    </section>


    </main>
</div>
</body>
</html>





